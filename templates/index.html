{% extends 'base.html' %}

{% block head %}
<title>Whisper Web - Index</title>
{% endblock %}

{% block body %}
<main class="flex flex-row justify-center items-center min-h-screen">
    <div class="container flex flex-col justify-center items-center">
        <h1 class="mb-5 text-5xl font-extrabold tracking-tight text-slate-900 sm:text-7xl text-center">Indonesian Lyrics
            Classification By Age Group</h1>
        <div class="w-full flex flex-col my-2 overflow-y-auto"></div>
        <h2 class="mt-4 mb-2 px-4 text-center text-1xl font-semibold tracking-tight text-slate-900 sm:text-2xl">
            Upload or Record Your Lyrics:</h2>
        <div
            class="mb-3 flex flex-col justify-center items-center rounded-lg bg-white shadow-xl shadow-black/5 ring-1 ring-slate-700/10">
            <div class="flex flex-row space-x-2 py-2 w-full px-2">
                <button id="uploadButton"
                    class="flex items-center justify-center rounded-lg p-2 bg-blue text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 transition-all duration-200">
                    <div class="w-7 h-7"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                            stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M3.75 9.776c.112-.017.227-.026.344-.026h15.812c.117 0 .232.009.344.026m-16.5 0a2.25 2.25 0 00-1.883 2.542l.857 6a2.25 2.25 0 002.227 1.932H19.05a2.25 2.25 0 002.227-1.932l.857-6a2.25 2.25 0 00-1.883-2.542m-16.5 0V6A2.25 2.25 0 016 3.75h3.879a1.5 1.5 0 011.06.44l2.122 2.12a1.5 1.5 0 001.06.44H18A2.25 2.25 0 0120.25 9v.776">
                            </path>
                        </svg></div>
                    <div class="ml-2 break-text text-center text-md w-30">From file</div>
                </button>
                <div class="w-[1px] bg-slate-200"></div>
                <button id="recordButton"
                    class="flex items-center justify-center rounded-lg p-2 bg-blue text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 transition-all duration-200">
                    <div class="w-7 h-7"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                            stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z">
                            </path>
                        </svg></div>
                    <div id="recordText" class="ml-2 break-text text-center text-md w-30">Record</div>
                </button>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-1 dark:bg-gray-700">
                <div class="bg-blue-600 h-1 rounded-full transition-all duration-100" style="width: 0%;"></div>
            </div>
        </div>

        <!-- Hidden playback and transcribe sections -->
        <div id="playback" class="mb-3 flex relative z-10 p-4 w-full hidden">
            <audio id="audioPlayer" controls
                class="w-full h-14 rounded-lg bg-white shadow-xl shadow-black/5 ring-1 ring-slate-700/10">
                <source id="audioSource" type="audio/mpeg" src="">
            </audio>
        </div>
        <div id="transcribe" class="relative w-full flex justify-center items-center hidden">
            <form action="/transcribe" method="POST" enctype="multipart/form-data">
                <input type="file" name="file" id="fileInput" accept=".mp3" class="hidden">
                <button type="button" onclick="showInputText()"
                    class="text-white bg-red-500 hover:bg-red-600 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                    Cancel
                </button>
                <button type="submit"
                    class="text-white bg-blue-700 hover:bg-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                    Predict Age Group
                </button>
            </form>
        </div>

        <!-- Text Input for Manual Lyrics Prediction -->
        <div class="mt-4 w-full mt-8" id="input-text">
            <form action="/predict-text" method="POST" class="flex flex-col space-y-4">
                <label for="lyricsInput"
                    class="mb-2 text-1xl font-semibold tracking-tight text-slate-900 sm:text-2xl">Or paste your lyric
                    here:</label>
                <textarea name="lyrics" id="lyricsInput" rows="6"
                    class="w-full rounded-lg border border-gray-300 px-2 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Type or paste Indonesian lyrics..."></textarea>
                <br>
                <button type="submit"
                    class="text-white bg-blue-700 hover:bg-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                    Predict Age Group
                </button>
            </form>
        </div>
    </div>
</main>
<footer class="flex flex-row justify-center items-center">
    <div class="absolute bottom-4 text-gray-500">By Michael Natanael</div>
</footer>
{% endblock %}

{% block script %}
<script>
    let mediaRecorder;
    let audioChunks = [];
    let recordingInterval;
    let seconds = 0;

    // Handle file upload
    document.getElementById("uploadButton").addEventListener("click", function () {
        document.getElementById("fileInput").click();
    });

    document.getElementById("fileInput").addEventListener("change", function (event) {
        if (event.target.files.length > 0) {
            let file = event.target.files[0];
            let fileURL = URL.createObjectURL(file);
            updateAudioPlayer(fileURL);
        }
    });

    // Handle audio recording
    document.getElementById("recordButton").addEventListener("click", async function () {
        if (!mediaRecorder || mediaRecorder.state === "inactive") {
            startRecording();
        } else {
            stopRecording();
        }
    });

    async function startRecording() {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = event => {
            audioChunks.push(event.data);
        };

        mediaRecorder.onstop = () => {
            clearInterval(recordingInterval); // Stop timer
            seconds = 0; // Reset timer

            const audioBlob = new Blob(audioChunks, { type: 'audio/mpeg' });
            const audioUrl = URL.createObjectURL(audioBlob);

            // Update the file input with recorded audio
            const file = new File([audioBlob], "recording.mp3", { type: "audio/mpeg" });
            const fileInput = document.getElementById("fileInput");
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;

            updateAudioPlayer(audioUrl);
            audioChunks = []; // Reset chunks
        };

        mediaRecorder.start();
        startTimer();
        document.getElementById("recordText").innerHTML = "Stop Recording (00:00)";
    }

    function startTimer() {
        recordingInterval = setInterval(() => {
            seconds++;
            let minutes = Math.floor(seconds / 60);
            let remainingSeconds = seconds % 60;
            let timeString = `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;

            document.getElementById("recordText").innerHTML = `Stop Recording (${timeString})`;
        }, 1000);
    }

    function stopRecording() {
        mediaRecorder.stop();
        document.getElementById("recordText").innerHTML = "Record";
    }

    // Function to update audio player and show playback & transcribe sections
    function updateAudioPlayer(audioUrl) {
        document.getElementById("audioSource").src = audioUrl;
        document.getElementById("audioPlayer").load(); // Refresh the audio player
        document.getElementById("playback").classList.remove("hidden");
        document.getElementById("transcribe").classList.remove("hidden");
        document.getElementById("input-text").classList.add("hidden");
    }

    function showInputText() {
        document.getElementById("playback").classList.add("hidden");
        document.getElementById("transcribe").classList.add("hidden");
        document.getElementById("input-text").classList.remove("hidden");
    }
</script>
{% endblock %}